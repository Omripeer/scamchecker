<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בודק אתרים והודעות | כלי חינמי לבדיקת בטיחות</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Assistant', sans-serif; }
        .tab.active {
            border-color: #3b82f6;
            background-color: white;
            color: #3b82f6;
        }
        #lang-switcher button.active {
             background-color: #3b82f6;
             color: white;
        }
        /* Style for disabled button */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* API Source badges */
        .api-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 4px;
            margin-left: 4px;
        }
        .api-badge.google { background-color: #4285F4; color: white; }
        .api-badge.virustotal { background-color: #394EFF; color: white; }
        .api-badge.phishtank { background-color: #FF6B35; color: white; }
        .api-badge.local { background-color: #6B7280; color: white; }
        .api-badge.ipqs { background-color: #10B981; color: white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">
        
        <div id="lang-switcher" class="flex justify-end mb-4">
            <button id="lang-he-btn" class="lang-btn he p-2 px-4 rounded-r-lg border border-gray-300 active">עברית</button>
            <button id="lang-en-btn" class="lang-btn en p-2 px-4 rounded-l-lg border border-gray-300">English</button>
        </div>

        <header class="text-center mb-8">
            <h1 id="main-title" class="text-4xl sm:text-5xl font-bold text-blue-600 mb-2">בודק האתרים וההודעות הבטוח</h1>
            <p id="subtitle" class="text-lg sm:text-xl text-gray-600">קיבלתם קישור או הודעה חשודה? בדקו אותם כאן.</p>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            
            <div class="flex border-b border-gray-200 mb-6">
                <button id="website-tab" class="tab flex-1 p-4 font-bold text-lg text-gray-500 border-b-4 border-transparent active">
                    בדיקת אתר אינטרנט
                </button>
                <button id="sms-tab" class="tab flex-1 p-4 font-bold text-lg text-gray-500 border-b-4 border-transparent">
                    בדיקת SMS / מספר טלפון
                </button>
            </div>

            <div id="website-checker" class="tab-content">
                <div class="flex flex-col items-center">
                    <input type="url" id="urlInput" placeholder="הדביקו כאן את כתובת האתר (לדוגמה: example.com)" class="w-full text-center text-lg p-4 border-2 border-gray-300 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <button id="url-check-btn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold text-xl py-4 px-10 rounded-xl shadow-md">בדיקה</button>
                </div>
            </div>
            
            <div id="sms-checker" class="tab-content hidden">
                 <div class="flex flex-col items-center">
                    <input type="tel" id="phoneInput" placeholder="הזן מספר טלפון (אופציונלי)" class="w-full text-center text-lg p-4 border-2 border-gray-300 rounded-xl mb-4">
                    <textarea id="smsInput" placeholder="הדבק את תוכן הודעת ה-SMS כאן" class="w-full text-center text-lg p-4 border-2 border-gray-300 rounded-xl mb-4" rows="4"></textarea>
                    <button id="sms-check-btn" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold text-xl py-4 px-10 rounded-xl shadow-md">בדיקת הודעה</button>
                </div>
            </div>

            <div id="loader" class="text-center my-4 hidden">
                <p id="loader-text" class="text-blue-600 font-semibold">מבצע בדיקה מקיפה, אנא המתינו...</p>
                 <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mt-2"></div>
            </div>
            <div id="results" class="text-center mt-6 p-4 rounded-lg text-xl font-bold"></div>
            <div id="report" class="text-right mt-4 p-6 border border-gray-200 rounded-lg bg-gray-50 hidden"></div>

        </main>

        <footer class="mt-8 text-center text-gray-500">
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                <h2 id="stats-title" class="text-2xl font-bold text-gray-700 mb-4">נתונים וסטטיסטיקה</h2>
                <div class="flex flex-col sm:flex-row justify-around items-center">
                    <div class="mb-4 sm:mb-0">
                        <h3 id="visitors-title" class="text-lg font-semibold">מספר מבקרים באתר:</h3>
                        <p id="visitorCounter" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div>
                        <h3 id="top-searches-title" class="text-lg font-semibold">10 הכתובות הנבדקות ביותר:</h3>
                        <ul id="topSearches" class="list-none text-gray-600">
                            <li id="top-searches-loading">טוען נתונים...</li>
                        </ul>
                    </div>
                </div>
            </div>
            <p id="footer-text" class="text-sm">&copy; 2024 בודק אתרים. כלי חינמי שנוצר כדי לשמור על בטיחותכם ברשת.</p>
        </footer>
    </div>

    <!-- Core UI Script (non-module, loads immediately) -->
    <script>
        // --- Language Dictionary ---
        const langDict = {
            'he': {
                'main-title': 'בודק האתרים וההודעות הבטוח', 
                'subtitle': 'קיבלתם קישור או הודעה חשודה? בדקו אותם כאן.', 
                'website-tab': 'בדיקת אתר אינטרנט', 
                'sms-tab': 'בדיקת SMS / מספר טלפון', 
                'urlInput_placeholder': 'הדביקו כאן את כתובת האתר', 
                'url-check-btn': 'בדיקה', 
                'phoneInput_placeholder': 'הזן מספר טלפון לבדיקה', 
                'smsInput_placeholder': 'הדבק את תוכן הודעת ה-SMS כאן (אופציונלי)', 
                'sms-check-btn': 'בדיקת הודעה / טלפון', 
                'loader-text': 'מבצע ניתוח מקיף של מספר מקורות...',
                'stats-title': 'נתונים וסטטיסטיקה', 
                'visitors-title': 'מספר מבקרים באתר:', 
                'top-searches-title': '10 הכתובות הנבדקות ביותר:', 
                'top-searches-loading': 'טוען נתונים...', 
                'footer-text': '&copy; 2024 בודק אתרים. כלי חינמי שנוצר כדי לשמור על בטיחותכם ברשת.', 
                'report-title': 'דו"ח ניתוח', 
                'report-result': 'מקור הבדיקה:', 
                'report-confidence': 'רמת ביטחון:', 
                'report-category': 'קטגוריה משוערכת:', 
                'report-sources': 'מקורות שנבדקו:',
                'report-community-title': 'עזרו לקהילה, דווחו:', 
                'report-how-received': 'איך קיבלת את הקישור?', 
                'report-submit': 'שלח דיווח', 
                'goto-site-btn': 'מעבר לאתר (נמצא בטוח)', 
                'error-message': 'אירעה שגיאה במהלך הבדיקה. אנא נסו שוב מאוחר יותר.', 
                'invalid-url-message': 'נא להזין כתובת אתר תקינה (למשל, example.com).', 
                'empty-sms-message': 'אנא הכניסו מספר טלפון או תוכן הודעה לבדיקה.', 
                'empty-sms-report': 'לא הוזן תוכן.',
                'phone-spam-detected': 'מספר הטלפון זוהה כחשוד לספאם!',
                'phone-safe': 'מספר הטלפון נראה תקין.',
                'phone-unknown': 'לא נמצא מידע על מספר זה.',
                'url-dangerous': 'סכנה! האתר זוהה כלא בטוח.',
                'url-suspicious': 'חשוד! נמצאו סימנים מחשידים באתר.',
                'url-safe': 'האתר נמצא בטוח.',
                'checking-google': 'בודק ב-Google Safe Browsing...',
                'checking-phishtank': 'בודק ב-PhishTank...',
                'checking-patterns': 'מנתח דפוסים חשודים...',
                'checking-phone': 'בודק מספר טלפון...'
            },
            'en': {
                'main-title': 'The Safe Website & SMS Checker', 
                'subtitle': 'Got a suspicious link or message? Check it here.', 
                'website-tab': 'Website Check', 
                'sms-tab': 'SMS / Phone Number Check', 
                'urlInput_placeholder': 'Paste the website address here', 
                'url-check-btn': 'Check', 
                'phoneInput_placeholder': 'Enter phone number to check', 
                'smsInput_placeholder': 'Paste the SMS message content here (optional)', 
                'sms-check-btn': 'Check Message / Phone', 
                'loader-text': 'Performing comprehensive multi-source analysis...', 
                'stats-title': 'Data & Statistics', 
                'visitors-title': 'Website Visitors:', 
                'top-searches-title': 'Top 10 Checked URLs:', 
                'top-searches-loading': 'Loading data...', 
                'footer-text': '&copy; 2024 Website Checker. A free tool to keep you safe online.', 
                'report-title': 'Analysis Report', 
                'report-result': 'Check Source:', 
                'report-confidence': 'Confidence Level:', 
                'report-category': 'Estimated Category:', 
                'report-sources': 'Sources Checked:',
                'report-community-title': 'Help the community, report it:', 
                'report-how-received': 'How did you receive the link?', 
                'report-submit': 'Submit Report', 
                'goto-site-btn': 'Proceed to Site (Found Safe)', 
                'error-message': 'An error occurred during the check. Please try again later.', 
                'invalid-url-message': 'Please enter a valid URL (e.g., example.com).', 
                'empty-sms-message': 'Please enter a phone number or message content to check.', 
                'empty-sms-report': 'No content entered.',
                'phone-spam-detected': 'Phone number detected as suspected spam!',
                'phone-safe': 'Phone number appears legitimate.',
                'phone-unknown': 'No information found for this number.',
                'url-dangerous': 'Danger! This website has been identified as unsafe.',
                'url-suspicious': 'Suspicious! Warning signs detected on this website.',
                'url-safe': 'Website found to be safe.',
                'checking-google': 'Checking Google Safe Browsing...',
                'checking-phishtank': 'Checking PhishTank...',
                'checking-patterns': 'Analyzing suspicious patterns...',
                'checking-phone': 'Checking phone number...'
            }
        };

        // --- Core State ---
        let currentLang = 'he';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Firebase references (will be set when Firebase loads)
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseDb = null;
        let searchesCollectionRef = null;
        let visitorCounterRef = null;

        // ===================================================================
        // PHONE NUMBER SPAM/SCAM DETECTION
        // ===================================================================
        
        // Known spam phone number patterns (Israeli and international)
        const spamPhonePatterns = {
            // Israeli spam patterns - premium numbers, known scam prefixes
            israeliSpam: [
                /^1-?900/,      // Premium rate numbers
                /^1-?901/,      // Premium rate numbers
                /^1-?902/,      // Premium rate numbers
                /^\*[0-9]{4}/,  // Short codes starting with *
                /^0(72|73|76|77|78|79)/, // VoIP ranges often used for spam
            ],
            // International premium/spam patterns
            internationalSpam: [
                /^\+?1-?900/,   // US Premium
                /^\+?44-?9/,    // UK Premium  
                /^\+?1-?876/,   // Jamaica - common scam origin
                /^\+?234/,      // Nigeria - common scam origin
                /^\+?233/,      // Ghana - common scam origin
                /^\+?355/,      // Albania - common scam origin
                /^\+?381/,      // Serbia - common scam origin
            ],
            // Suspicious patterns
            suspicious: [
                /^(\d)\1{6,}/,  // Same digit repeated 7+ times
                /1234567/,      // Sequential numbers
                /7654321/,      // Reverse sequential
            ]
        };

        // Known spam numbers database (community-reported, commonly reported in Israel)
        const knownSpamNumbers = new Set([
            // Example commonly reported spam numbers - this list should be expanded
            '0722222222', '0733333333', '0799999999',
            '1-900-999-9999', '1-800-SCAM',
        ]);

        /**
         * Check phone number against local spam patterns and database
         * @param {string} phone - Phone number to check
         * @returns {object} - Result with level, message, and details
         */
        function checkPhoneLocal(phone) {
            // Normalize phone number
            const normalizedPhone = phone.replace(/[\s\-\(\)\.]/g, '');
            
            // Check known spam numbers
            if (knownSpamNumbers.has(normalizedPhone)) {
                return {
                    isSpam: true,
                    confidence: 'high',
                    reason: currentLang === 'he' ? 'מספר זה מופיע במאגר הספאם הידוע' : 'This number is in the known spam database',
                    source: 'Local Database'
                };
            }
            
            // Check Israeli spam patterns
            for (const pattern of spamPhonePatterns.israeliSpam) {
                if (pattern.test(normalizedPhone)) {
                    return {
                        isSpam: true,
                        confidence: 'high',
                        reason: currentLang === 'he' ? 'מספר פרימיום או VoIP חשוד' : 'Premium or suspicious VoIP number',
                        source: 'Pattern Analysis'
                    };
                }
            }
            
            // Check international spam patterns
            for (const pattern of spamPhonePatterns.internationalSpam) {
                if (pattern.test(normalizedPhone)) {
                    return {
                        isSpam: true,
                        confidence: 'medium',
                        reason: currentLang === 'he' ? 'מספר ממדינה עם שכיחות גבוהה של הונאות' : 'Number from country with high fraud rate',
                        source: 'Pattern Analysis'
                    };
                }
            }
            
            // Check suspicious patterns
            for (const pattern of spamPhonePatterns.suspicious) {
                if (pattern.test(normalizedPhone)) {
                    return {
                        isSpam: true,
                        confidence: 'low',
                        reason: currentLang === 'he' ? 'מספר עם דפוס חשוד' : 'Number with suspicious pattern',
                        source: 'Pattern Analysis'
                    };
                }
            }
            
            return {
                isSpam: false,
                confidence: 'medium',
                reason: currentLang === 'he' ? 'לא נמצאו דפוסי ספאם ידועים' : 'No known spam patterns found',
                source: 'Pattern Analysis'
            };
        }

        /**
         * Check phone using IPQualityScore API (free tier: 5000/month)
         * This is optional - requires API key configuration
         * API Documentation: https://www.ipqualityscore.com/documentation/phone-number-validation-api/overview
         */
        async function checkPhoneIPQS(phone, apiKey) {
            if (!apiKey) return null;
            
            try {
                const encodedPhone = encodeURIComponent(phone);
                const response = await fetch(`https://www.ipqualityscore.com/api/json/phone/${apiKey}/${encodedPhone}?country[]=IL&country[]=US`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) return null;
                
                const data = await response.json();
                
                if (data.success) {
                    return {
                        isSpam: data.fraud_score > 75 || data.recent_abuse || data.VOIP,
                        confidence: data.fraud_score > 85 ? 'high' : (data.fraud_score > 50 ? 'medium' : 'low'),
                        reason: data.fraud_score > 75 ? 
                            (currentLang === 'he' ? `ציון סיכון גבוה: ${data.fraud_score}/100` : `High risk score: ${data.fraud_score}/100`) :
                            (currentLang === 'he' ? `ציון סיכון: ${data.fraud_score}/100` : `Risk score: ${data.fraud_score}/100`),
                        source: 'IPQualityScore API',
                        details: {
                            fraudScore: data.fraud_score,
                            valid: data.valid,
                            carrier: data.carrier,
                            lineType: data.line_type,
                            voip: data.VOIP,
                            recentAbuse: data.recent_abuse
                        }
                    };
                }
            } catch (error) {
                console.error('IPQS API Error:', error);
            }
            return null;
        }

        /**
         * Combined phone number spam check
         */
        async function checkPhoneSpam(phone) {
            const results = {
                sources: [],
                isSpam: false,
                confidence: 'low',
                details: []
            };
            
            // Local pattern check (always runs)
            const localResult = checkPhoneLocal(phone);
            results.sources.push({ name: 'Local', badge: 'local' });
            results.details.push(localResult);
            
            if (localResult.isSpam) {
                results.isSpam = true;
                results.confidence = localResult.confidence;
            }
            
            // IPQS API check (optional - runs if key is configured)
            // Users can set their own API key here for enhanced detection
            const ipqsApiKey = window.IPQS_API_KEY || null;
            if (ipqsApiKey) {
                const ipqsResult = await checkPhoneIPQS(phone, ipqsApiKey);
                if (ipqsResult) {
                    results.sources.push({ name: 'IPQS', badge: 'ipqs' });
                    results.details.push(ipqsResult);
                    
                    if (ipqsResult.isSpam && !results.isSpam) {
                        results.isSpam = true;
                        results.confidence = ipqsResult.confidence;
                    } else if (ipqsResult.isSpam && results.isSpam) {
                        results.confidence = 'high'; // Both sources agree
                    }
                }
            }
            
            return results;
        }

        // ===================================================================
        // URL/WEBSITE SPAM/SCAM DETECTION  
        // ===================================================================

        // Suspicious URL patterns for phishing/scam detection
        const suspiciousUrlPatterns = {
            // Typosquatting of popular domains
            typosquatting: [
                /paypa[l1].*\.(?!com)/i,
                /g[o0]{2}g[l1]e/i,
                /fac[e3]b[o0]{2}k/i,
                /amaz[o0]n/i,
                /app[l1]e.*(?!\.com)/i,
                /micr[o0]s[o0]ft/i,
                /bank.*login/i,
                /login.*bank/i,
            ],
            // Suspicious TLDs often used in scams
            suspiciousTlds: [
                /\.(tk|ml|ga|cf|gq|xyz|top|work|click|link|vip|loan|win|racing)$/i,
            ],
            // Suspicious patterns in URL
            suspiciousPatterns: [
                /[.-]secure[.-]/i,
                /[.-]login[.-]/i,
                /[.-]verify[.-]/i,
                /[.-]update[.-]/i,
                /[.-]account[.-]/i,
                /[.-]confirm[.-]/i,
                /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/, // IP address URLs
                /@.*@/,  // Multiple @ symbols
                /[.-]\.com/,  // Suspicious subdomain pattern
            ],
            // Hebrew-specific phishing patterns
            hebrewScamPatterns: [
                /bit\.ly/i,
                /tinyurl/i,
                /t\.co/i,
                // Israeli bank impersonation patterns
                /leumi.*login/i,
                /poalim.*login/i,
                /discount.*bank/i,
                /mizrahi.*tefahot/i,
            ]
        };

        // Known safe domains (whitelist)
        const knownSafeDomains = new Set([
            'google.com', 'google.co.il', 'facebook.com', 'youtube.com',
            'microsoft.com', 'apple.com', 'amazon.com', 'amazon.co.il',
            'bankleumi.co.il', 'poalim.co.il', 'mizrahi-tefahot.co.il',
            'gov.il', 'police.gov.il', 'btl.gov.il'
        ]);

        /**
         * Extract domain from URL
         */
        function extractDomain(url) {
            try {
                let processedUrl = url.trim().toLowerCase();
                if (!processedUrl.startsWith('http://') && !processedUrl.startsWith('https://')) {
                    processedUrl = 'https://' + processedUrl;
                }
                const urlObj = new URL(processedUrl);
                return urlObj.hostname.replace(/^www\./, '');
            } catch {
                return url.replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0];
            }
        }

        /**
         * Check URL against local suspicious patterns
         */
        function checkUrlLocal(url) {
            const domain = extractDomain(url);
            const warnings = [];
            let riskLevel = 0;
            
            // Check if domain is in whitelist
            if (knownSafeDomains.has(domain)) {
                return {
                    isSuspicious: false,
                    confidence: 'high',
                    reason: currentLang === 'he' ? 'דומיין ידוע ובטוח' : 'Known safe domain',
                    source: 'Local Whitelist',
                    warnings: []
                };
            }
            
            // Check typosquatting
            for (const pattern of suspiciousUrlPatterns.typosquatting) {
                if (pattern.test(url)) {
                    warnings.push(currentLang === 'he' ? 'חשד להתחזות לאתר ידוע' : 'Suspected impersonation of known site');
                    riskLevel += 3;
                }
            }
            
            // Check suspicious TLDs
            for (const pattern of suspiciousUrlPatterns.suspiciousTlds) {
                if (pattern.test(domain)) {
                    warnings.push(currentLang === 'he' ? 'סיומת דומיין חשודה' : 'Suspicious domain extension');
                    riskLevel += 2;
                }
            }
            
            // Check suspicious patterns
            for (const pattern of suspiciousUrlPatterns.suspiciousPatterns) {
                if (pattern.test(url)) {
                    warnings.push(currentLang === 'he' ? 'דפוס URL חשוד' : 'Suspicious URL pattern');
                    riskLevel += 1;
                }
            }
            
            // Check Hebrew scam patterns
            for (const pattern of suspiciousUrlPatterns.hebrewScamPatterns) {
                if (pattern.test(url)) {
                    warnings.push(currentLang === 'he' ? 'קישור מקוצר או דפוס הונאה ידוע' : 'Shortened link or known scam pattern');
                    riskLevel += 2;
                }
            }
            
            // URL length check (very long URLs are often phishing)
            if (url.length > 100) {
                warnings.push(currentLang === 'he' ? 'כתובת ארוכה באופן חשוד' : 'Suspiciously long URL');
                riskLevel += 1;
            }
            
            // Multiple subdomains check
            const subdomainCount = (domain.match(/\./g) || []).length;
            if (subdomainCount > 3) {
                warnings.push(currentLang === 'he' ? 'מספר רב של תת-דומיינים' : 'Excessive subdomains');
                riskLevel += 2;
            }
            
            return {
                isSuspicious: riskLevel > 0,
                confidence: riskLevel >= 4 ? 'high' : (riskLevel >= 2 ? 'medium' : 'low'),
                reason: warnings.length > 0 ? warnings.join('; ') : (currentLang === 'he' ? 'לא נמצאו דפוסים חשודים' : 'No suspicious patterns found'),
                source: 'Pattern Analysis',
                warnings: warnings,
                riskScore: riskLevel
            };
        }

        /**
         * Check URL using Google Safe Browsing API
         */
        async function checkUrlGoogleSafeBrowsing(url) {
            const googleApiKey = 'AIzaSyDkl8DVlrtb2vLuWgZEGlHokuZELCwpO4Q';
            
            try {
                const response = await fetch(`https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${googleApiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        client: { clientId: `secure-hebrew-checker-${appId}`, clientVersion: '6.0.0' },
                        threatInfo: {
                            threatTypes: ['MALWARE', 'SOCIAL_ENGINEERING', 'UNWANTED_SOFTWARE', 'POTENTIALLY_HARMFUL_APPLICATION'],
                            platformTypes: ['ANY_PLATFORM'],
                            threatEntryTypes: ['URL'],
                            threatEntries: [{ url }]
                        }
                    })
                });

                if (!response.ok) {
                    console.error("Safe Browsing API Error:", await response.text());
                    return null;
                }
                
                const data = await response.json();
                
                if (data.matches && data.matches.length > 0) {
                    const threatType = data.matches[0].threatType.replace(/_/g, ' ');
                    return {
                        isMalicious: true,
                        confidence: 'high',
                        reason: currentLang === 'he' ? `סוג איום: ${threatType}` : `Threat type: ${threatType}`,
                        source: 'Google Safe Browsing',
                        threatType: threatType
                    };
                }
                
                return {
                    isMalicious: false,
                    confidence: 'high',
                    reason: currentLang === 'he' ? 'לא נמצאו איומים' : 'No threats found',
                    source: 'Google Safe Browsing'
                };
            } catch (error) {
                console.error('Google Safe Browsing Error:', error);
                return null;
            }
        }

        /**
         * Check URL using PhishTank API (free, no key required for lookups)
         * Note: PhishTank is community-driven and focuses specifically on phishing
         * API: https://www.phishtank.com/api_info.php
         */
        async function checkUrlPhishTank(url) {
            // PhishTank requires base64 encoding of URL and form submission
            // For client-side, we use their checkurl API
            try {
                const formData = new FormData();
                formData.append('url', url);
                formData.append('format', 'json');
                
                // Note: PhishTank API may have CORS restrictions
                // This is a best-effort check
                const response = await fetch('https://checkurl.phishtank.com/checkurl/', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) return null;
                
                const data = await response.json();
                
                return {
                    isPhishing: data.results?.in_database && data.results?.valid,
                    confidence: data.results?.verified ? 'high' : 'medium',
                    reason: data.results?.in_database ? 
                        (currentLang === 'he' ? 'נמצא במאגר הפישינג' : 'Found in phishing database') :
                        (currentLang === 'he' ? 'לא נמצא במאגר' : 'Not found in database'),
                    source: 'PhishTank',
                    phishtankUrl: data.results?.phish_detail_page
                };
            } catch (error) {
                // PhishTank API may fail due to CORS - this is expected
                console.log('PhishTank check skipped (CORS):', error.message);
                return null;
            }
        }

        /**
         * Combined URL spam/scam check
         */
        async function checkUrlSpam(url) {
            const results = {
                sources: [],
                isDangerous: false,
                isSuspicious: false,
                confidence: 'low',
                details: []
            };
            
            // Update loader text
            const loaderText = document.getElementById('loader-text');
            
            // Local pattern check (always runs first)
            if (loaderText) loaderText.textContent = langDict[currentLang]['checking-patterns'];
            const localResult = checkUrlLocal(url);
            results.sources.push({ name: 'Local', badge: 'local' });
            results.details.push(localResult);
            
            if (localResult.isSuspicious) {
                results.isSuspicious = true;
                if (localResult.confidence === 'high') {
                    results.confidence = 'medium';
                }
            }
            
            // Google Safe Browsing check
            if (loaderText) loaderText.textContent = langDict[currentLang]['checking-google'];
            const googleResult = await checkUrlGoogleSafeBrowsing(url);
            if (googleResult) {
                results.sources.push({ name: 'Google', badge: 'google' });
                results.details.push(googleResult);
                
                if (googleResult.isMalicious) {
                    results.isDangerous = true;
                    results.confidence = 'high';
                }
            }
            
            // PhishTank check (may fail due to CORS but worth trying)
            if (loaderText) loaderText.textContent = langDict[currentLang]['checking-phishtank'];
            const phishTankResult = await checkUrlPhishTank(url);
            if (phishTankResult) {
                results.sources.push({ name: 'PhishTank', badge: 'phishtank' });
                results.details.push(phishTankResult);
                
                if (phishTankResult.isPhishing) {
                    results.isDangerous = true;
                    results.confidence = 'high';
                }
            }
            
            return results;
        }

        // --- Core UI Functions ---
        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
            for (const id in langDict[lang]) {
                const element = document.getElementById(id);
                if (element) {
                    if (id.includes('_placeholder')) { element.placeholder = langDict[lang][id]; }
                    else { element.innerHTML = langDict[lang][id]; }
                }
            }
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const langBtn = document.querySelector(`.lang-btn.${lang}`);
            if (langBtn) langBtn.classList.add('active');
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const tabContent = document.getElementById(`${tabName}-checker`);
            if (tabContent) tabContent.classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            const tabBtn = document.getElementById(`${tabName}-tab`);
            if (tabBtn) tabBtn.classList.add('active');
            clearResults();
        }

        function clearResults() {
            const resultsEl = document.getElementById('results');
            const reportEl = document.getElementById('report');
            if (resultsEl) {
                resultsEl.innerHTML = '';
                resultsEl.className = 'text-center mt-6 p-4 rounded-lg text-xl font-bold';
            }
            if (reportEl) reportEl.classList.add('hidden');
        }

        function displayFinalResults(result, type, url) {
            const resultsDiv = document.getElementById('results');
            const reportDiv = document.getElementById('report');
            const colors = { high: 'bg-red-100 text-red-700', medium: 'bg-yellow-100 text-yellow-700', low: 'bg-blue-100 text-blue-700', safe: 'bg-green-100 text-green-700' };
            resultsDiv.className = `text-center mt-6 p-4 rounded-lg text-xl font-bold ${colors[result.level]}`;
            resultsDiv.innerHTML = `<p>${result.message}</p>`;

            if ((result.level === 'safe' || result.level === 'low') && type === 'url' && url) {
                const button = document.createElement('a');
                button.href = url.startsWith('http') ? url : `https://${url}`;
                button.textContent = langDict[currentLang]['goto-site-btn'];
                button.target = '_blank';
                button.rel = 'noopener noreferrer';
                button.className = 'block w-max mx-auto mt-4 bg-blue-600 text-white font-bold text-lg py-2 px-6 rounded-lg hover:bg-blue-700';
                resultsDiv.appendChild(button);
            }
            
            // Generate sources badges HTML
            let sourcesHtml = '';
            if (result.sources && result.sources.length > 0) {
                sourcesHtml = `<div class="mb-4"><strong>${langDict[currentLang]['report-sources']}</strong> `;
                result.sources.forEach(src => {
                    sourcesHtml += `<span class="api-badge ${src.badge}">${src.name}</span>`;
                });
                sourcesHtml += '</div>';
            }
            
            let categoryHtml = result.category ? `<div class="mb-2"><strong>${langDict[currentLang]['report-category']}</strong> ${result.category}</div>` : '';
            
            // Generate detailed findings HTML
            let detailsHtml = '';
            if (result.details && result.details.length > 0) {
                detailsHtml = '<div class="mt-4 space-y-2">';
                result.details.forEach(detail => {
                    const icon = detail.isSpam || detail.isMalicious || detail.isPhishing || detail.isSuspicious ? '⚠️' : '✅';
                    detailsHtml += `<div class="p-2 bg-white rounded border text-sm">
                        <span class="font-semibold">${icon} ${detail.source}:</span> ${detail.reason}
                    </div>`;
                });
                detailsHtml += '</div>';
            }
            
            reportDiv.innerHTML = `
                <h3 class="text-xl font-bold mb-4">${langDict[currentLang]['report-title']}</h3>
                ${sourcesHtml}
                <div class="mb-2"><strong>${langDict[currentLang]['report-result']}</strong> ${result.report}</div>
                <div class="mb-4"><strong>${langDict[currentLang]['report-confidence']}</strong> ${result.confidence}</div>
                ${categoryHtml}
                ${detailsHtml}
                <hr class="my-4">
                <h4 class="text-lg font-bold mb-2">${langDict[currentLang]['report-community-title']}</h4>
                <form id="community-report-form">
                     <select class="w-full p-2 border rounded-lg mb-2"><option>${langDict[currentLang]['report-how-received']}</option><option>SMS</option><option>Email</option><option>WhatsApp</option></select>
                    <button type="submit" class="w-full bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">${langDict[currentLang]['report-submit']}</button>
                </form>
            `;
            reportDiv.classList.remove('hidden');
            
            // Add event listener for the community report form
            const form = document.getElementById('community-report-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    this.innerHTML = '<p class="text-green-600">תודה!</p>';
                });
            }
            
            setLanguage(currentLang);
        }

        function processSms(inputText, phone) {
            // Enhanced SMS checking with more keywords
            const lowercasedInput = inputText.toLowerCase();
            const keywords = [
                // Hebrew scam keywords
                "זכית", "פרס", "חשבונך ייסגר", "דחוף", "אימות פרטים", "לעדכון לחץ כאן",
                "חסימת חשבון", "אשר עכשיו", "פעולה נדרשת", "משלוח ממתין", "חבילה ממתינה",
                "אימות זהות", "עדכן פרטים", "כרטיס אשראי", "סיסמה", "קוד אימות",
                // English scam keywords  
                "winner", "prize", "urgent", "verify", "confirm", "suspended",
                "lottery", "inheritance", "million", "password", "click here",
                "act now", "limited time", "free gift"
            ];
            const foundKeywords = keywords.filter(k => lowercasedInput.includes(k));

            if (foundKeywords.length > 0) {
                return {
                    isSpam: true,
                    confidence: foundKeywords.length >= 3 ? 'high' : 'medium',
                    reason: currentLang === 'he' 
                        ? `נמצאו ביטויים חשודים: "${foundKeywords.slice(0, 3).join(', ')}"` 
                        : `Suspicious phrases found: "${foundKeywords.slice(0, 3).join(', ')}"`,
                    source: 'Keyword Analysis',
                    keywords: foundKeywords
                };
            }
            
            return {
                isSpam: false,
                confidence: 'medium',
                reason: currentLang === 'he' ? 'לא נמצאו מילות מפתח חשודות' : 'No suspicious keywords found',
                source: 'Keyword Analysis'
            };
        }

        async function runCheck(type) {
            clearResults();
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const urlButton = document.getElementById('url-check-btn');
            const smsButton = document.getElementById('sms-check-btn');

            loader.classList.remove('hidden');
            urlButton.disabled = true;
            smsButton.disabled = true;

            try {
                if (type === 'url') {
                    const url = document.getElementById('urlInput').value.trim();
                    if (!url || !/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/.test(url)) {
                        displayFinalResults({ 
                            level: 'medium', 
                            message: langDict[currentLang]['invalid-url-message'], 
                            report: currentLang === 'he' ? 'לא הוזנה כתובת תקינה.' : 'Invalid URL entered.',
                            confidence: 'N/A',
                            sources: [],
                            details: []
                        });
                        return;
                    }
                    
                    // Use comprehensive URL checking
                    const urlCheckResult = await checkUrlSpam(url);
                    
                    // Determine result level and message
                    let level, message, category;
                    if (urlCheckResult.isDangerous) {
                        level = 'high';
                        message = langDict[currentLang]['url-dangerous'];
                        category = currentLang === 'he' ? 'אתר מסוכן' : 'Dangerous Site';
                    } else if (urlCheckResult.isSuspicious && urlCheckResult.confidence !== 'low') {
                        level = 'medium';
                        message = langDict[currentLang]['url-suspicious'];
                        category = currentLang === 'he' ? 'אתר חשוד' : 'Suspicious Site';
                    } else {
                        level = 'safe';
                        message = langDict[currentLang]['url-safe'];
                        category = currentLang === 'he' ? 'אתר תקין' : 'Safe Site';
                    }
                    
                    // Build report message
                    const reportMessages = urlCheckResult.details
                        .filter(d => d.reason)
                        .map(d => d.reason);
                    
                    displayFinalResults({
                        level: level,
                        message: message,
                        report: reportMessages.join(' | ') || (currentLang === 'he' ? 'הבדיקה הושלמה.' : 'Check completed.'),
                        confidence: urlCheckResult.confidence === 'high' 
                            ? (currentLang === 'he' ? 'גבוהה' : 'High')
                            : urlCheckResult.confidence === 'medium'
                                ? (currentLang === 'he' ? 'בינונית' : 'Medium')
                                : (currentLang === 'he' ? 'נמוכה' : 'Low'),
                        category: category,
                        sources: urlCheckResult.sources,
                        details: urlCheckResult.details
                    }, 'url', url);
                    
                    // Increment search count if Firebase is available
                    if (typeof incrementSearchCount === 'function') {
                        await incrementSearchCount(url);
                    }

                } else { // SMS/Phone Check
                    const phone = document.getElementById('phoneInput').value.trim();
                    const sms = document.getElementById('smsInput').value.trim();
                    
                    if (!phone && !sms) {
                        displayFinalResults({ 
                            level: 'medium', 
                            message: langDict[currentLang]['empty-sms-message'], 
                            report: langDict[currentLang]['empty-sms-report'], 
                            confidence: 'N/A',
                            sources: [],
                            details: []
                        });
                        return;
                    }
                    
                    const results = {
                        sources: [],
                        isSpam: false,
                        confidence: 'low',
                        details: []
                    };
                    
                    // Check phone number if provided
                    if (phone) {
                        if (loaderText) loaderText.textContent = langDict[currentLang]['checking-phone'];
                        const phoneResult = await checkPhoneSpam(phone);
                        results.sources.push(...phoneResult.sources);
                        results.details.push(...phoneResult.details);
                        
                        if (phoneResult.isSpam) {
                            results.isSpam = true;
                            results.confidence = phoneResult.confidence;
                        }
                    }
                    
                    // Check SMS content if provided
                    if (sms) {
                        if (loaderText) loaderText.textContent = langDict[currentLang]['checking-patterns'];
                        const smsResult = processSms(sms, phone);
                        results.sources.push({ name: 'Keywords', badge: 'local' });
                        results.details.push(smsResult);
                        
                        if (smsResult.isSpam) {
                            results.isSpam = true;
                            if (smsResult.confidence === 'high' || results.confidence !== 'high') {
                                results.confidence = smsResult.confidence;
                            }
                        }
                    }
                    
                    // Determine result level and message
                    let level, message;
                    if (results.isSpam && results.confidence === 'high') {
                        level = 'high';
                        message = langDict[currentLang]['phone-spam-detected'];
                    } else if (results.isSpam) {
                        level = 'medium';
                        message = currentLang === 'he' ? 'נמצאו סימנים חשודים - יש להיזהר!' : 'Suspicious signs found - be careful!';
                    } else {
                        level = 'safe';
                        message = phone ? langDict[currentLang]['phone-safe'] : 
                            (currentLang === 'he' ? 'ההודעה נראית תקינה.' : 'Message appears legitimate.');
                    }
                    
                    // Build report message
                    const reportMessages = results.details
                        .filter(d => d.reason)
                        .map(d => d.reason);
                    
                    displayFinalResults({
                        level: level,
                        message: message,
                        report: reportMessages.join(' | ') || (currentLang === 'he' ? 'הבדיקה הושלמה.' : 'Check completed.'),
                        confidence: results.confidence === 'high' 
                            ? (currentLang === 'he' ? 'גבוהה' : 'High')
                            : results.confidence === 'medium'
                                ? (currentLang === 'he' ? 'בינונית' : 'Medium')
                                : (currentLang === 'he' ? 'נמוכה' : 'Low'),
                        sources: results.sources,
                        details: results.details
                    }, 'phone', phone);
                }
            } catch(error) {
                console.error("A critical error occurred in runCheck:", error);
                displayFinalResults({ 
                    level: 'high', 
                    message: langDict[currentLang]['error-message'], 
                    report: `Error details: ${error.message}`, 
                    confidence: 'N/A',
                    sources: [],
                    details: []
                });
            } finally {
                loader.classList.add('hidden');
                urlButton.disabled = false;
                smsButton.disabled = false;
            }
        }

        // --- Initialize Core UI on DOM Ready ---
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners for buttons
            document.getElementById('website-tab').addEventListener('click', function() { openTab('website'); });
            document.getElementById('sms-tab').addEventListener('click', function() { openTab('sms'); });
            document.getElementById('url-check-btn').addEventListener('click', function() { runCheck('url'); });
            document.getElementById('sms-check-btn').addEventListener('click', function() { runCheck('sms'); });
            document.getElementById('lang-he-btn').addEventListener('click', function() { setLanguage('he'); });
            document.getElementById('lang-en-btn').addEventListener('click', function() { setLanguage('en'); });
            
            // Set initial language
            setLanguage('he');
        });
    </script>

    <!-- Firebase Module Script (loads asynchronously, enhances functionality) -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "your-fallback-api-key" };

        try {
            // --- Initialization ---
            firebaseApp = initializeApp(firebaseConfig);
            firebaseAuth = getAuth(firebaseApp);
            firebaseDb = getFirestore(firebaseApp);
            
            // --- Firebase References ---
            searchesCollectionRef = collection(firebaseDb, `artifacts/${appId}/public/data/searches`);
            visitorCounterRef = doc(firebaseDb, `artifacts/${appId}/public/data/stats/visitorCounter`);

            // --- Firebase Functions ---
            async function authenticateUser() { 
                try { 
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { 
                        await signInWithCustomToken(firebaseAuth, __initial_auth_token); 
                    } else { 
                        await signInAnonymously(firebaseAuth); 
                    } 
                    console.log("User authenticated."); 
                } catch (error) { 
                    console.error("Authentication failed:", error); 
                } 
            }
            
            async function updateGlobalVisitorCounter() { 
                try { 
                    await runTransaction(firebaseDb, async (t) => { 
                        const docSnap = await t.get(visitorCounterRef); 
                        if (!docSnap.exists()) { 
                            t.set(visitorCounterRef, { count: 1 }); 
                        } else { 
                            t.update(visitorCounterRef, { count: docSnap.data().count + 1 }); 
                        } 
                    }); 
                } catch (e) { 
                    console.error("Visitor counter transaction failed: ", e); 
                } 
            }

            function listenForVisitorCount() { 
                const el = document.getElementById('visitorCounter'); 
                onSnapshot(visitorCounterRef, (doc) => { 
                    el.textContent = doc.exists() ? doc.data().count.toLocaleString() : '1'; 
                }, (error) => { 
                    console.error("Visitor counter listener failed:", error); 
                    el.textContent = 'N/A'; 
                }); 
            }
            
            // Expose incrementSearchCount to global scope
            window.incrementSearchCount = async function(url) { 
                if (!firebaseAuth.currentUser) return; 
                const docId = btoa(url); 
                const docRef = doc(searchesCollectionRef, docId); 
                try { 
                    await runTransaction(firebaseDb, async (t) => { 
                        const sfDoc = await t.get(docRef); 
                        if (!sfDoc.exists()) { 
                            t.set(docRef, { url, count: 1, lastSearched: serverTimestamp() }); 
                        } else { 
                            t.update(docRef, { count: sfDoc.data().count + 1, lastSearched: serverTimestamp() }); 
                        } 
                    }); 
                } catch (e) { 
                    console.error("Search count transaction failed: ", e); 
                } 
            };

            function listenForTopSearches() { 
                const listEl = document.getElementById('topSearches');
                onSnapshot(searchesCollectionRef, (snapshot) => { 
                    const searchCounts = [];
                    snapshot.forEach((doc) => searchCounts.push(doc.data()));
                    const sorted = searchCounts.sort((a, b) => b.count - a.count).slice(0, 10);
                    
                    listEl.innerHTML = ''; 
                    if (sorted.length === 0) { 
                        const li = document.createElement('li');
                        li.id = 'top-searches-loading';
                        li.textContent = langDict[currentLang]['top-searches-loading'];
                        listEl.appendChild(li);
                        return; 
                    } 
                    sorted.forEach(s => { 
                        const item = document.createElement('li'); 
                        const name = s.url.length > 35 ? s.url.substring(0, 32) + '...' : s.url; 
                        item.textContent = `${name} (${s.count.toLocaleString()})`; 
                        item.className = 'py-1'; 
                        listEl.appendChild(item); 
                    }); 
                }, (error) => { 
                    console.error("Top searches listener failed:", error); 
                    listEl.innerHTML = `<li>Error loading data.</li>`; 
                }); 
            }

            // --- Firebase Initialization ---
            await authenticateUser();
            await updateGlobalVisitorCounter();
            listenForVisitorCount();
            listenForTopSearches();
            
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            // Firebase features will be unavailable, but core functionality still works
        }
    </script>
</body>
</html>

