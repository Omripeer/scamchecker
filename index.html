<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בודק אתרים | כלי חינמי לבדיקת אתרים חשודים</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using a clear and friendly Hebrew font */
        body {
            font-family: 'Assistant', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">

        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-blue-600 mb-2">בודק האתרים הבטוח</h1>
            <p class="text-lg sm:text-xl text-gray-600">קיבלתם קישור חשוד? הדביקו את כתובת האתר ובדקו אם הוא בטוח לשימוש.</p>
        </header>

        <!-- Main Checker Section -->
        <main class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div class="flex flex-col items-center">
                <label for="urlInput" class="sr-only">הדביקו כאן את כתובת האתר</label>
                <input type="url" id="urlInput" placeholder="הדביקו כאן את כתובת האתר (לדוגמה: example.com)" class="w-full text-center text-lg p-4 border-2 border-gray-300 rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                
                <button onclick="checkUrl()" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold text-xl py-4 px-10 rounded-xl shadow-md hover:shadow-lg transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    בדיקה
                </button>
            </div>

            <!-- Results Area -->
            <div id="loader" class="text-center my-4 hidden">
                <p class="text-blue-600 font-semibold">בודק את האתר, אנא המתינו רגע...</p>
                 <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mt-2"></div>
            </div>
            <div id="results" class="text-center mt-6 p-4 rounded-lg text-xl font-bold"></div>
        </main>

        <!-- Footer and Stats Section -->
        <footer class="mt-8 text-center text-gray-500">
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">נתונים וסטטיסטיקה</h2>
                <div class="flex flex-col sm:flex-row justify-around items-center">
                    <!-- Visitor Counter -->
                    <div class="mb-4 sm:mb-0">
                        <h3 class="text-lg font-semibold">מספר מבקרים באתר:</h3>
                        <p id="visitorCounter" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <!-- Top Searches -->
                    <div>
                        <h3 class="text-lg font-semibold">10 הכתובות הנבדקות ביותר:</h3>
                        <ul id="topSearches" class="list-none text-gray-600">
                            <!-- Top searches will be populated by JavaScript -->
                            <li>טוען נתונים...</li>
                        </ul>
                    </div>
                </div>
            </div>
            <p class="text-sm">&copy; 2024 בודק אתרים. כלי חינמי שנוצר כדי לשמור על בטיחותכם ברשת.</p>
        </footer>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, setDoc, onSnapshot, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        // These variables are provided by the environment and should not be changed.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "your-fallback-api-key", authDomain: "your-fallback-auth-domain", projectId: "your-fallback-project-id" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Collection reference for storing search counts
        const searchesCollection = collection(db, `artifacts/${appId}/public/data/searches`);

        /**
         * Signs the user in. Uses a custom token if available, otherwise falls back to anonymous sign-in.
         */
        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        }
        
        /**
         * Updates the visitor counter on the page using the browser's local storage.
         * This counter is unique to each user's browser.
         */
        function updateVisitorCounter() {
            let visits = localStorage.getItem('pageVisits');
            visits = visits ? Number(visits) + 1 : 1;
            localStorage.setItem('pageVisits', visits);
            document.getElementById('visitorCounter').textContent = visits.toLocaleString();
        }

        /**
         * Increments the search count for a given URL in Firestore.
         * Uses a transaction to ensure the count is updated atomically.
         * @param {string} url - The URL that was searched.
         */
        async function incrementSearchCount(url) {
            if (!auth.currentUser) {
                console.error("User not authenticated, cannot track search.");
                return;
            }
            // Sanitize URL to create a valid document ID
            const docId = url.replace(/[^a-zA-Z0-9.-]/g, '_');
            const docRef = doc(searchesCollection, docId);

            try {
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(docRef);
                    if (!sfDoc.exists()) {
                        transaction.set(docRef, { url: url, count: 1, lastSearched: serverTimestamp() });
                    } else {
                        const newCount = sfDoc.data().count + 1;
                        transaction.update(docRef, { count: newCount, lastSearched: serverTimestamp() });
                    }
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
            }
        }

        /**
         * Listens for real-time updates to the search data and displays the top 10.
         */
        function listenForTopSearches() {
            onSnapshot(searchesCollection, (snapshot) => {
                const searchCounts = [];
                snapshot.forEach((doc) => {
                    searchCounts.push(doc.data());
                });

                // Sort by count descending and take the top 10
                const sortedSearches = searchCounts.sort((a, b) => b.count - a.count).slice(0, 10);
                
                const topSearchesList = document.getElementById('topSearches');
                topSearchesList.innerHTML = ''; // Clear previous list

                if (sortedSearches.length === 0) {
                     topSearchesList.innerHTML = '<li>עדיין לא בוצעו חיפושים.</li>';
                     return;
                }

                sortedSearches.forEach(search => {
                    const listItem = document.createElement('li');
                    // Truncate long URLs for display purposes
                    const displayName = search.url.length > 35 ? search.url.substring(0, 32) + '...' : search.url;
                    listItem.textContent = `${displayName} (${search.count.toLocaleString()} בדיקות)`;
                    listItem.className = 'py-1';
                    topSearchesList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error listening for top searches:", error);
                const topSearchesList = document.getElementById('topSearches');
                topSearchesList.innerHTML = '<li>לא ניתן היה לטעון את הנתונים.</li>';
            });
        }
        
        /**
         * Checks the provided URL against the Google Safe Browsing API.
         */
        async function performSafetyCheck() {
            const urlToCheck = document.getElementById('urlInput').value.trim();
            const resultsDiv = document.getElementById('results');
            const loader = document.getElementById('loader');
            
            // API key is now included here
            const apiKey = 'AIzaSyDkl8DVlrtb2vLuWgZEGlHokuZELCwpO4Q';

            resultsDiv.innerHTML = '';
            resultsDiv.className = 'text-center mt-6 p-4 rounded-lg text-xl font-bold'; // Reset styles

            if (!urlToCheck) {
                resultsDiv.textContent = 'אנא הכניסו כתובת לבדיקה.';
                resultsDiv.classList.add('text-yellow-600');
                return;
            }
            
            loader.classList.remove('hidden');
            
            const apiUrl = `https://safebrowsing.googleapis.com/v4/threatMatches:find?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client: {
                            clientId: `safe-hebrew-checker-${appId}`,
                            clientVersion: '1.0.0'
                        },
                        threatInfo: {
                            threatTypes: ['MALWARE', 'SOCIAL_ENGINEERING', 'THREAT_TYPE_UNSPECIFIED', 'UNWANTED_SOFTWARE', 'POTENTIALLY_HARMFUL_APPLICATION'],
                            platformTypes: ['ANY_PLATFORM'],
                            threatEntryTypes: ['URL'],
                            threatEntries: [{ url: urlToCheck }]
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const data = await response.json();

                // If the response contains 'matches', the URL is considered unsafe.
                if (data.matches && data.matches.length > 0) {
                    resultsDiv.innerHTML = '<strong>סכנה!</strong> לאחר בדיקה במספר מקורות, האתר מופיע כלא אמין. <br>אנא הימנעו מכניסה לאתר וממסירת פרטים אישיים.';
                    resultsDiv.classList.add('bg-red-100', 'text-red-700');
                } else {
                    // If no matches, the URL is not on the blocklist.
                    resultsDiv.innerHTML = '<strong>האתר נראה בטוח.</strong> לא נמצא מידע שלילי על האתר במאגרים שבדקנו. <br>עם זאת, תמיד יש לנהוג בזהירות ולא למסור פרטים אישיים.';
                    resultsDiv.classList.add('bg-green-100', 'text-green-700');
                }
                
                // Track the search in Firestore regardless of the result.
                await incrementSearchCount(urlToCheck);

            } catch (error) {
                console.error('Error checking URL:', error);
                resultsDiv.textContent = 'אירעה שגיאה במהלך הבדיקה. אנא נסו שוב מאוחר יותר.';
                resultsDiv.classList.add('bg-yellow-100', 'text-yellow-700');
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        // --- Global Setup ---
        // Make the checkUrl function available globally so the button's onclick can find it.
        window.checkUrl = performSafetyCheck;

        // Initialize the page when it loads.
        document.addEventListener('DOMContentLoaded', async () => {
            updateVisitorCounter();
            await authenticateUser();
            listenForTopSearches();
        });

    </script>

</body>
</html>

